<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="last-modified" content="2015-06-25T12:53:29.4374900+05:30" />
    <title>Kunjan a.k.a. Kunjee's blog</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/ico">
    <link rel="shortcut icon" href="/images/favicon.gif" type="image/gif">
    <link rel="canonical" href="http://kunjan.in/2014/03/signalr-nancy-azure-with-fsharp/" />
</head>
<body class="home blog">
    <div id="page" class="hfeed site">
        <header id="masthead" class="site-header fancy-container lightgreen" role="banner">
            <hgroup>
                <h1 class="site-title"><a href="/" title="Kunjee's Blog" rel="home">Kunjan's Blog</a></h1>
                <h2><small>Why Did the Chicken Cross the MÃ¶bius Strip?</small></h2>
                <p class="site-description"> All idea, opinion are my own and don't reflect opinion of my current or any former employer. </p>
                
        </hgroup>
        <nav role="navigation" class="site-navigation main-navigation">
            <h1 class="assistive-text">Menu</h1>
            <div class="assistive-text skip-link"><a href="#content" title="Skip to content">Skip to content</a></div>
            <div class="menu">
                <ul>

                    <li><a href="/category">Categories</a></li>
                    <li><a href="/archive">Archive</a></li>
                    <li><a href="/resume">Resume</a></li>
                    <li><a href="/about">About</a></li>
                    <li><a href="/search">Search</a></li>
                    <li><a href="/rss.xml">RSS</a> / <a href="/feed.xml">Atom</a></li>
                </ul>
            </div>
        </nav>
    </header>
    <div id="main">
        <div id="primary" class="site-content">
            <div id="content" role="main">

                
<meta name="description" content="Using SignalR framework with F#. Also solve the issue of Dynamic with F#" />
<meta name="author" content="Kunjan Dalal" />
<div id="post">
  <h1>SignalR + Nancy with F# hosted on Azure</h1>
  <div class="post-note">
    posted on 28 Mar 2014
    | <a href="/category/technical">Technical</a>
    | <a href="/category/dotnet">DotNet</a>
    | <a href="/category/oss">OSS</a>
    | <a href="/category/functional-programming">Functional Programming</a>
    | <a href="/category/functional-web">Functional Web</a>
    | <a href="/category/web">Web</a>
    | <a href="/category/azure">Azure</a>

<!--       <div class="addthis_toolbox addthis_default_style" style="float:right;">
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        <a class="addthis_button_tweet"></a>
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
        <a class="addthis_button_linkedin_counter"></a>
        <a class="addthis_counter addthis_pill_style"></a>
      </div>
    -->

    <!-- AddThis Button BEGIN -->
    <div class="hidden-phone">
      <div class="addthis_toolbox addthis_default_style addthis_32x32_style" addthis:title="SignalR + Nancy with F# hosted on Azure">
        <a class="addthis_button_preferred_1"></a>
        <a class="addthis_button_preferred_2"></a>
        <a class="addthis_button_preferred_3"></a>
        <a class="addthis_button_preferred_4"></a>
        <a class="addthis_button_compact"></a>
        <a class="addthis_counter addthis_bubble_style"></a>
      </div>
    </div>
    <!-- AddThis Button END -->




  </div>

  

  <p>What you feel if you meet your favourite actor? Feeling is wonderful right? Now, add the your actress in the mixture. Have you said WOW??? How about director? Still heart is beating?!? How about having dinner with them? Nothing can be better than that.
<!--excerpt-->
I am having kinda same feeling. It is nothing new that <a href="http://nancyfx.org/">Nancy</a> is dancing quite comfortable with <a href="http://fsharp.org">F#</a>. And thanks to Daniel Mohl we are also having <a href="http://visualstudiogallery.msdn.microsoft.com/b55b8aac-b11a-4a6a-8a77-2153f46f4e2f">templates</a> to get started with Nancy and F#. </p>

<p>Now, I was doing some experiments around it. It was quite good. But how about running it on Owin. hmmm, it works flow less. Nothing more on code side other than few lines here and there. Then I found few projects running <a href="http://signalr.net/">SignalR</a> with F#. </p>

<p>I knowing Nancy from a long time. But SignalR, I don't know anything about it. The only thing I know is that, it is super awesome. </p>

<p>So, first task is to run Nancy on Owin. </p>

<p>Here are simple steps. Using template create a asp.net host with razor project. remove asp.net host and add <a href="http://www.nuget.org/packages/Nancy.Owin/">Owin host</a> using nuget package manager.</p>

<p>Now we need to add startup file. </p>

<pre><code>type Startup() = 
    member x.Configuration(app : Owin.IAppBuilder) =  app.UseNancy() |&gt; ignore


[&lt;Microsoft.Owin.OwinStartup(typeof&lt;Startup&gt;)&gt;]
do ()
</code></pre>

<p>And add simple Nancy code. The regular one. Nothing fancy. </p>

<p>There is bootstrap class</p>

<pre><code>type Bootstrapper() =
    inherit DefaultNancyBootstrapper()
    override x.ApplicationStartup(container:TinyIoCContainer, pipelines:IPipelines) = 
        StaticConfiguration.DisableErrorTraces &lt;- false
        base.ApplicationStartup(container,pipelines)
        ignore()
</code></pre>

<p><em>this is needed to trace the error if anything is there at nancy end.</em></p>

<p>And our index module </p>

<pre><code>type IndexModule() as x =
    inherit NancyModule()
    do x.Get.["/"] &lt;- fun _ -&gt; box x.View.["Index"]
</code></pre>

<p>Pretty lame right. But it works.</p>

<p>Now, add <a href="http://www.nuget.org/packages/Microsoft.AspNet.SignalR/">Signalr asp.net host nuget package</a> to project. As startup file is already there; no need to create one more. Just minor modification will do.</p>

<pre><code>type Startup() = 
    member x.Configuration(app : Owin.IAppBuilder) =  app.MapSignalR().UseNancy() |&gt; ignore
</code></pre>

<p>That MapSignalR thing is additionally added. I have just followed Hello World example of real time world. Create a chat application. So, here is the hub to broadcast the message to all users.</p>

<pre><code>type ChatHub() as this = 
    inherit Hub()
    member x.send (name : string, msg : string) = this.Clients.All?broadcastMessage (name, msg) |&gt; ignore
</code></pre>

<p>Now, copy paste code for html part. Here is code snippet. There is no need to go into detail as of now for JavaScript part.  </p>

<pre><code>&lt;div&gt;
    &lt;p&gt;Here is singnal R working great with Nancy&lt;/p&gt;
    &lt;div class="container"&gt;
        &lt;input type="text" id="message" /&gt;
        &lt;input type="button" id="sendmessage" value="Send" /&gt;
        &lt;input type="hidden" id="displayname" /&gt;
        &lt;ul id="discussion"&gt;&lt;/ul&gt;
    &lt;/div&gt;

&lt;/div&gt;
&lt;!--Script references. --&gt;
&lt;!--Reference the jQuery library. --&gt;
&lt;script src="Scripts/jquery-1.6.4.min.js"&gt;&lt;/script&gt;
&lt;!--Reference the SignalR library. --&gt;
&lt;script src="Scripts/jquery.signalR-2.0.2.min.js"&gt;&lt;/script&gt;
&lt;!--Reference the autogenerated SignalR hub script. --&gt;
&lt;script src="signalr/hubs"&gt;&lt;/script&gt;
&lt;!--Add script to update the page and send messages.--&gt;
&lt;script type="text/javascript"&gt;
    $(function () {
        // Declare a proxy to reference the hub.
        var chat = $.connection.chatHub;
        // Create a function that the hub can call to broadcast messages.
        chat.client.broadcastMessage = function (name, msg) {
            // Html encode display name and message.

            var encodedName = $('&lt;div /&gt;').text(name).html();
            var encodedMsg = $('&lt;div /&gt;').text(msg).html();
            // Add the message to the page.
            $('#discussion').append('&lt;li&gt;&lt;strong&gt;' + encodedName
                + '&lt;/strong&gt;:&amp;nbsp;&amp;nbsp;' + encodedMsg + '&lt;/li&gt;');
        };
        // Get the user name and store it to prepend to messages.
        $('#displayname').val(prompt('Enter your name:', ''));
        // Set initial focus to message input box.
        $('#message').focus();
        // Start the connection.
        $.connection.hub.start().done(function () {
            $('#sendmessage').click(function () {
                // Call the Send method on the hub.
                chat.server.send($('#displayname').val(), $('#message').val());
                // Clear text box and reset focus for next comment.
                $('#message').val('').focus();
            });
        });
    });
&lt;/script&gt;
</code></pre>

<p>Now, there is one "?" thing before broadcastMessage function. That is where dynamic method is getting called. F# do not support dynamic by default but there are many work around available. I personally prefer <a href="http://www.nuget.org/packages/FSharp.Dynamic/">Fsharp.dynamic</a> library. It is better than other code snippets I found over other sites. But that is all personal choice how one like to handle dynamic functions. </p>

<p>So, it is done. Hit F5 and you are ready to go.</p>

<p>What is fun of working with Web if I can't publish it. But for now with F# web templates it is not possible. And that is known <a href="https://github.com/fsharp/FSharpCommunityTemplates/issues/28">issue</a>. So, if I like to publish it on cloud like azure I need to give git hooks. That is easiest thing I can think off. But road is still not that smooth. </p>

<p>Deployment will break with some weird error. I followed <a href="http://blog.ploeh.dk/2013/08/26/running-a-pure-f-web-api-on-azure-web-sites/">Mark's article</a> to make it work. </p>

<p>Needed to add below lines to .fsproj file after its own import tags. </p>

<pre><code>&lt;Import Project="$(VSToolsPath)\WebApplications\Microsoft.WebApplication.targets" 
        Condition="'$(VSToolsPath)' != ''" /&gt;
&lt;Import Project="$(MSBuildExtensionsPath32)\Microsoft\VisualStudio\v11.0\WebApplications\Microsoft.WebApplication.targets" 
        Condition="true" /&gt;
</code></pre>

<p>And things are working like anything. No, issues at all. </p>

<blockquote>
  <p>Nancy |> Razor |> SignalR |> Azure |> F# |> lots of love.</p>
</blockquote>

<p>Please give it a shot. If it break somewhere let me know will try to solve it. Any suggestion to make things even better and streamlined are always welcome.</p>

<p><strong>UPDATE:</strong> Here is my <a href="https://github.com/kunjee17/NancySignalRFSharp">github repo</a> with updated code. Project created with web express 2013. Also it is deployed over <a href="http://nancysignalrfsharp.azurewebsites.net/">azure</a>.</p>


  <div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://kunjan.in/2014/03/signalr-nancy-azure-with-fsharp/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'kunjan';
    var disqus_url = 'http://kunjan.in/2014/03/signalr-nancy-azure-with-fsharp/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f054dec05e2662c"></script>

</div>
            </div>
            <!-- #content -->
        </div>
        <!-- #primary .site-content -->

        <div id="secondary" class="widget-area fancy-container lightred" role="complementary">
            <aside id="text-5" class="widget widget_text">
                <h1 class="widget-title">Follow</h1>
                <div class="textwidget logos">
                    <a href="https://twitter.com/kunjee" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://twitter.com']);"><img src="/stylesheets/images/twitter.png"></a>
                    <a href="http://stackoverflow.com/users/859490/kunjee" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://stackoverflow.com']);"><img src="/stylesheets/images/stackoverflow.png"></a>
                    <a href="http://www.linkedin.com/in/kunjee17" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://www.linkedin.com']);"><img src="/stylesheets/images/linkedin.png"></a>
                    <a href="https://github.com/kunjee17" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://github.com']);"><img src="/stylesheets/images/github.png"></a>

                </div>
                <a href="http://stackoverflow.com/users/859490/kunjee" target="_blank">
                  <img src="http://stackoverflow.com/users/flair/859490.png" width="208" height="58" alt="profile for Kunjan at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for Kunjan at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
              </a>

          </aside>

          <aside id="linkcat-6" class="widget widget_links">
            <h1 class="widget-title">Other Blogs</h1>
            <ul class='xoxo blogroll'>
                <li><a href="http://www.hanselman.com/blog/" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://www.hanselman.com/blog/']);">Scott Hanselman</a></li>
                <li><a href="http://www.wekeroad.com/" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://www.wekeroad.com/']);">Rob Conery</a></li>
                <li><a href="http://haacked.com/" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://haacked.com/']);">Phil Haack</a></li>
                <li><a href="http://hanselminutes.com/" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://hanselminutes.com/']);">Hanselminutes</a></li>
                <li><a href="https://sergeytihon.wordpress.com/category/f-weekly/" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','https://sergeytihon.wordpress.com/category/f-weekly/']);">F# Weekly</a></li>
                <li><a href="http://fsharpforfunandprofit.com/" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://fsharpforfunandprofit.com/']);">F# for Fun and Profit</a></li>
            </ul>

        </aside>
        <aside id="archives-4" class="widget widget_archive">
            <h1 class="widget-title">Archive</h1>
            <ul class="posts">
                <li><a href="/archive#20154">April, 2015</a></li>
                <li><a href="/archive#20153">March, 2015</a></li>
                <li><a href="/archive#201411">November, 2014</a></li>
                <li><a href="/archive#201410">October, 2014</a></li>
                <li><a href="/archive#20146">June, 2014</a></li>
                <li><a href="/archive#20144">April, 2014</a></li>
                <li><a href="/archive#20143">March, 2014</a></li>
                <li><a href="/archive#20142">February, 2014</a></li>
                <li><a href="/archive#201312">December, 2013</a></li>
                <li><a href="/archive#201311">November, 2013</a></li>
                <li><a href="/archive#201310">October, 2013</a></li>
                <li><a href="/archive#20138">August, 2013</a></li>
                <li><a href="/archive#20131">January, 2013</a></li>
                <li><a href="/archive#201212">December, 2012</a></li>
                <li><a href="/archive#201211">November, 2012</a></li>
                <li><a href="/archive#201210">October, 2012</a></li>
                <li><a href="/archive#20129">September, 2012</a></li>
                <li><a href="/archive#20124">April, 2012</a></li>
                <li><a href="/archive#20123">March, 2012</a></li>
                <li><a href="/archive#20122">February, 2012</a></li>
                <li><a href="/archive#20121">January, 2012</a></li>
                <li><a href="/archive#201112">December, 2011</a></li>
                <li><a href="/archive#201111">November, 2011</a></li>
                <li><a href="/archive#201110">October, 2011</a></li>
        </ul>
    </aside>
</div>
<!-- #secondary .widget-area -->


</div>
<!-- #main -->

<footer id="colophon" class="site-footer" role="contentinfo">
    <div class="site-info">
        Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a>.	
    </div>
    <!-- .site-info -->
</footer>
<!-- #colophon .site-footer -->
</div>
<!-- #page .hfeed .site -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src='/javascripts/prettify.js' type='text/javascript'></script>

<script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-37975068-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>

<script type='text/javascript'>
  $(function () {
    $("pre code").parent().each(function () {
      if (!$(this).hasClass("prettyprint")) {
        $(this).addClass("prettyprint");
        a = true
    }
});

    prettyPrint();
});


  $(function(){
    $.ajax({
        url: "http://dynamic.xkcd.com/api-0/jsonp/comic?callback=?",
        dataType: "json",
        jsonpCallback: "xkcddata",
        success: function(data) {
            $("#xkcdcontent").append(
                $("<h1/>").text(data.title),
                $("<img/>").attr({
                    src: data.img,
                    title: data.alt,
                    alt: data.title
                })
                );
        }
    });
});
</script>
</body>
</html>
