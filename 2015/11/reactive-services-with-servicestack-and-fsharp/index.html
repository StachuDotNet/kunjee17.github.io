<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="last-modified" content="2015-12-19T13:30:38.8411034+05:30" />
    <title>Kunjan a.k.a. Kunjee's blog</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/ico">
    <link rel="shortcut icon" href="/images/favicon.gif" type="image/gif">
    <link rel="canonical" href="http://kunjan.in/2015/11/reactive-services-with-servicestack-and-fsharp/" />
</head>
<body class="home blog">
    <div id="page" class="hfeed site">
        <header id="masthead" class="site-header fancy-container lightgreen" role="banner">
            <hgroup>
                <h1 class="site-title"><a href="/" title="Kunjee's Blog" rel="home">Kunjan's Blog</a></h1>
                <h2><small>Why Did the Chicken Cross the MÃ¶bius Strip?</small></h2>
                <p class="site-description"> All idea, opinion are my own and don't reflect opinion of my current or any former employer. </p>
                
        </hgroup>
        <nav role="navigation" class="site-navigation main-navigation">
            <h1 class="assistive-text">Menu</h1>
            <div class="assistive-text skip-link"><a href="#content" title="Skip to content">Skip to content</a></div>
            <div class="menu">
                <ul>

                    <li><a href="/category">Categories</a></li>
                    <li><a href="/archive">Archive</a></li>
                    <li><a href="/resume">Resume</a></li>
                    <li><a href="/about">About</a></li>
                    <li><a href="/search">Search</a></li>
                    <li><a href="/rss.xml">RSS</a> / <a href="/feed.xml">Atom</a></li>
                </ul>
            </div>
        </nav>
    </header>
    <div id="main">
        <div id="primary" class="site-content">
            <div id="content" role="main">

                
<meta name="description" content="Creating reactive services using F# actors and Servicestack" />
<meta name="author" content="Kunjan Dalal" />
<div id="post">
  <h1>Reactive Services with Servicestack and F#</h1>
  <div class="post-note">
    posted on 30 Nov 2015
    | <a href="/category/technical">Technical</a>
    | <a href="/category/oss">OSS</a>
    | <a href="/category/functional">Functional</a>
    | <a href="/category/functional-programming">Functional Programming</a>
    | <a href="/category/functional-web">Functional Web</a>

<!--       <div class="addthis_toolbox addthis_default_style" style="float:right;">
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        <a class="addthis_button_tweet"></a>
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
        <a class="addthis_button_linkedin_counter"></a>
        <a class="addthis_counter addthis_pill_style"></a>
      </div>
    -->

    <!-- AddThis Button BEGIN -->
    <div class="hidden-phone">
      <div class="addthis_toolbox addthis_default_style addthis_32x32_style" addthis:title="Reactive Services with Servicestack and F#">
        <a class="addthis_button_preferred_1"></a>
        <a class="addthis_button_preferred_2"></a>
        <a class="addthis_button_preferred_3"></a>
        <a class="addthis_button_preferred_4"></a>
        <a class="addthis_button_compact"></a>
        <a class="addthis_counter addthis_bubble_style"></a>
      </div>
    </div>
    <!-- AddThis Button END -->




  </div>

  

  <p>Reactive word is not new nowadays. If you want your library to get limelight, use reactive word in the name any way possible and it will definitely get initial attention. Reactive word is appropriate for things that follows <a href="http://www.reactivemanifesto.org/">reactive manifesto</a>. That is true for now. And there are many variant of libraries on server and client to fulfil this.</p>

<p>Let's start from the start of web.</p>

<!--excerpt-->

<p>We were having old web were we used to do post event of page. At the time of posting whole page goes to server. And then <em>loading loading loading</em> of the page. But after the rise of <a href="https://jquery.com/">JQuery</a> page refresh become the thing of past. AJAX was there even before JQuery but become widely used after that only. 
Now, that spinner which was there in browser tab bar / address bar came in center of page. </p>

<blockquote>
  <p><strong>Side Note</strong>: If you want to make ajax request faster just use a spinner <strong>gif</strong> which spins faster. Tried and tested thing. With no code change performance issue will be resolved. </p>
</blockquote>

<p>With hardware getting better and if I be more specific more connected it is easy to store lots of data. And this makes things slower eventually. And user have to wait even for ajax request. So, what is next. With <a href="http://html5doctor.com/">HTML5</a> allowing Web Sockets and Server Events things are becoming real-time as now pushing data from Server to client is possible. </p>

<p>Server and Client is no more one-sided love story. Now, both can send message to each other. This new change allows build more reactive system. </p>

<p>Let's take example. I request my friend to come with me to visit <code>X</code> place. I got answer <code>yes, will go.</code> So, my request is accepted but we haven't visited that place. Visit is still pending. After sometime we visited. So, result happen. I don't have to ask again and again. But that event pushed by that end.</p>

<p>Same goes for server. In post event client request for some data. But that data may or may not be available at that specific moment. So, Server can send <code>201 - Accepted</code> status to client. So, data is accepted and waiting for processed result. And whenever result it ready server push data to client. This way neither server is blocked nor client. </p>

<blockquote>
  <p>There is will be no need for spinner. Neither slow not fast. </p>
</blockquote>

<p><a href="http://signalr.net/">SignalR</a> is very well-known example of real-time processing. But I wanted to achieve this by API framework. And nothing can be better than <a href="https://servicestack.net/">Servicestack</a>. It is having Server Sent Event / Server Event support in all 4+ version. So, why not?</p>

<p>Let's jump into code. Code is in <a href="http://fsharp.org/">F#</a>. It is in F# for a reason and that you will know. Keep on reading. </p>

<p>I am running a standalone Servicestack host but same code will working with Asp.net host also. </p>

<p><code>Programe.fs</code></p>

<pre><code>module reactiveServicestack.main
open ServiceStack
open System
open ServiceStack.Logging

type AppHost() = 
    inherit AppHostHttpListenerBase ("Hello F# Service", typeof&lt;HelloService&gt;.Assembly)
    override this.Configure container = 
        this.Plugins.Add(new PostmanFeature()) |&gt; ignore
        this.Plugins.Add(new CorsFeature()) |&gt; ignore
        this.Plugins.Add(new ServerEventsFeature()) |&gt; ignore
        let serverEventsFeature = this.GetPlugin&lt;ServerEventsFeature&gt;() 
        printfn "%s" serverEventsFeature.StreamPath
        ignore()


[&lt;EntryPoint&gt;]
let main args = 
    LogManager.LogFactory &lt;- new ConsoleLogFactory()
    let env_port = Environment.GetEnvironmentVariable("PORT")
    let port = if env_port = null then "1234" else env_port
    let host = "http://localhost:8080/"
    printfn "listening on %s ..." host
    let appHost = new AppHost()
    appHost.Init() |&gt; ignore
    appHost.Start host |&gt; ignore
    while true do Console.ReadLine() |&gt; ignore
    0 // return an integer exit code
</code></pre>

<p>Above code is very much classic Servicestack. Nothing fancy here. </p>

<p><code>HelloDto.fs</code></p>

<pre><code>namespace reactiveServicestack
open System
open ServiceStack

//I can't but CLI can mutate this one
[&lt;CLIMutable&gt;]
type HelloResponse = { Result:string }


//There always be hello world, atleast something should be running
[&lt;Route("/hello")&gt;]
[&lt;Route("/hello/{name}")&gt;]
type Hello() =
    interface IReturn&lt;HelloResponse&gt;
    member val Name = "" with get, set
</code></pre>

<p>Again, POCO members. Hello and HelloResponse. No magic here also. </p>

<p><code>AsyncProcessor.fs</code></p>

<pre><code>#nowarn "40"
namespace reactiveServicestack

module SSE =
    open ServiceStack
    let private serverEvent = ServiceStackHost.Instance.Container.TryResolve&lt;IServerEvents&gt;()
    let NotifyAll (msg:'T) = serverEvent.NotifyAll(msg)



module AsyncProcess =
    open System

    let rnd = new Random()
    let agent = 
        MailboxProcessor.Start(fun inbox -&gt; 
            let rec messageLoop = 
                async {
                    let! (msg:Hello) = inbox.Receive()
                    do! Async.Sleep(3000)
                    Console.WriteLine("Original " + msg.Name)
                    let reversed = msg.Name.ToCharArray() |&gt; Array.rev |&gt; fun x -&gt; new String (x)
                    Console.WriteLine("Reversed " + reversed)
                    SSE.NotifyAll({HelloResponse.Result = reversed})
                    return! messageLoop
                }
            messageLoop)
</code></pre>

<p>Here fun starts. I am creating Actor which takes Hello typed message and NotifyAll with HelloResponse after processing name string. </p>

<p>Let's understand complicated parts. </p>

<p>I have created SSE module because if I open Servicestack I was getting <code>asyncbuilder</code> compile error at async keyword. And I needed to open it to expose all the extension methods. So, I wrap things up in another module. </p>

<p><em>Don't</em> create seperate instance of any kind of ServerEvent implementation instead resolve it as above. Else things will surely not work. I was stuck at that problem for couple of days. </p>

<p>Actor is very much traditional, I am reversing a string and as it is <em>very complex</em> process. My actor will take precisely <strong>3</strong> seconds to do it. And then I am notifying to all from actor itself. </p>

<blockquote>
  <p>In ideal case it should be Subscriber ID/s or Channel/s.</p>
</blockquote>

<p>As, actor is async by nature it may complicate stuff to return things from agent loop. If you have used framework like <a href="http://getakka.net/">AKKA</a> you must be knowing that <code>ASK</code> is performance heavy in compare to <code>TELL</code>. This way you can fire result from Actor itself. </p>

<p>Now, you can easily guess what service will look like</p>

<p><code>Hello.fs</code>
    namespace reactiveServicestack
    open ServiceStack
        open ServiceStack.Logging
        open System
        open System.Net</p>

<pre><code>    type HelloService() =
        inherit Service()
        member val serverEvents:IServerEvents = null with get, set
        member this.Get (request:Hello) = 
            {Result = "Hello " + request.Name}
        member this.Post (request: Hello) =
            AsyncProcess.agent.Post(request)
            HttpStatusCode.Accepted
</code></pre>

<p>And final piece of puzzle <strong>HTML</strong> 
<code>default.html</code>
    <html></p>

<pre><code>&lt;head&gt;
    &lt;title&gt;Reactive Servicestack&lt;/title&gt;
    &lt;link href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.css" rel='stylesheet' type='text/css'&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div&gt;Hello this is default page&lt;/div&gt;
    &lt;div&gt;
        &lt;label for="name"&gt;Enter Your name&lt;/label&gt;
        &lt;input type="text" id="name" value="" /&gt;
        &lt;button id="reverse"&gt;Reverse&lt;/button&gt;
        &lt;ul&gt;

        &lt;/ul&gt;
    &lt;/div&gt;
    &lt;script src="//code.jquery.com/jquery-2.1.4.min.js"&gt;&lt;/script&gt;
    &lt;script src="/js/ss-utils.js"&gt;&lt;/script&gt;
    &lt;script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.js"&gt;&lt;/script&gt;
    &lt;script type="text/javascript"&gt;
        $('#name').keypress(function (e) {
            var key = e.which;
            if(key == 13)  // the enter key code
            {
                $('#reverse').click();
                $('#name').val('');
                return false;  
            }
        }); 
        $('#reverse').click(function(e) {
            e.preventDefault();
            var name = $('#name').val();

            if (name != '' || name != undefined) {
                $.post('/hello', {
                        name: name
                    })
                    .done(function() {
                        toastr.success(name + ' is very much Accepted!')
                    });
            }
        });
        var addName = function(reversedName) {
            $('ul').append('&lt;li&gt;' + reversedName + '&lt;/li&gt;');
        };
        var channel = 'home';
        var eventSource = new EventSource('/event-stream?channel=home&amp;t=' + new Date().getTime());
        $(eventSource).handleServerEvents({
            handlers: {
                HelloResponse: function(msg) {
                        console.log(msg);
                        addName(msg.Result);
                    }
                    //... Register custom handlers
            }
        });

    &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>

<p>I am taking post request and returning <code>201-accepted</code> instead of <code>200-ok</code> from server. On client it will go in <code>success</code> callback only.  </p>

<p>This way we can easily decouple server and client. And this can be used for games, stock market, betting or other reactive systems. </p>

<p>I am not going in detail of Actor or AKKA but as it natively available in F# so I used it. One of the reason beside being more fun while writing code. </p>

<p>Please provide your input for this. I don't know this is right / wrong or can't say. But it is very much possible that using current technology even without enabling Web Sockets (<em>Most of the cloud provider supports web sockets</em>) one can create reactive web services.</p>

<blockquote>
  <p>P.S. - With this there will be no need for spinner at all.</p>
</blockquote>


  <div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://kunjan.in/2015/11/reactive-services-with-servicestack-and-fsharp/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'kunjan';
    var disqus_url = 'http://kunjan.in/2015/11/reactive-services-with-servicestack-and-fsharp/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f054dec05e2662c"></script>

</div>
            </div>
            <!-- #content -->
        </div>
        <!-- #primary .site-content -->

        <div id="secondary" class="widget-area fancy-container lightred" role="complementary">
            <aside id="text-5" class="widget widget_text">
                <h1 class="widget-title">Follow</h1>
                <div class="textwidget logos">
                    <a href="https://twitter.com/kunjee" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://twitter.com']);"><img src="/stylesheets/images/twitter.png"></a>
                    <a href="http://stackoverflow.com/users/859490/kunjee" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://stackoverflow.com']);"><img src="/stylesheets/images/stackoverflow.png"></a>
                    <a href="http://www.linkedin.com/in/kunjee17" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://www.linkedin.com']);"><img src="/stylesheets/images/linkedin.png"></a>
                    <a href="https://github.com/kunjee17" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://github.com']);"><img src="/stylesheets/images/github.png"></a>

                </div>
                <a href="http://stackoverflow.com/users/859490/kunjee" target="_blank">
                  <img src="http://stackoverflow.com/users/flair/859490.png" width="208" height="58" alt="profile for Kunjan at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for Kunjan at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
              </a>

          </aside>

          <aside id="linkcat-6" class="widget widget_links">
            <h1 class="widget-title">Other Blogs</h1>
            <ul class='xoxo blogroll'>
                <li><a href="http://www.hanselman.com/blog/" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://www.hanselman.com/blog/']);">Scott Hanselman</a></li>
                <li><a href="http://www.wekeroad.com/" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://www.wekeroad.com/']);">Rob Conery</a></li>
                <li><a href="http://haacked.com/" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://haacked.com/']);">Phil Haack</a></li>
                <li><a href="http://hanselminutes.com/" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://hanselminutes.com/']);">Hanselminutes</a></li>
                <li><a href="https://sergeytihon.wordpress.com/category/f-weekly/" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','https://sergeytihon.wordpress.com/category/f-weekly/']);">F# Weekly</a></li>
                <li><a href="http://fsharpforfunandprofit.com/" target="_blank" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://fsharpforfunandprofit.com/']);">F# for Fun and Profit</a></li>
            </ul>

        </aside>
        <aside id="archives-4" class="widget widget_archive">
            <h1 class="widget-title">Archive</h1>
            <ul class="posts">
                <li><a href="/archive#201512">December, 2015</a></li>
                <li><a href="/archive#201511">November, 2015</a></li>
                <li><a href="/archive#20154">April, 2015</a></li>
                <li><a href="/archive#20153">March, 2015</a></li>
                <li><a href="/archive#201411">November, 2014</a></li>
                <li><a href="/archive#201410">October, 2014</a></li>
                <li><a href="/archive#20146">June, 2014</a></li>
                <li><a href="/archive#20144">April, 2014</a></li>
                <li><a href="/archive#20143">March, 2014</a></li>
                <li><a href="/archive#20142">February, 2014</a></li>
                <li><a href="/archive#201312">December, 2013</a></li>
                <li><a href="/archive#201311">November, 2013</a></li>
                <li><a href="/archive#201310">October, 2013</a></li>
                <li><a href="/archive#20138">August, 2013</a></li>
                <li><a href="/archive#20131">January, 2013</a></li>
                <li><a href="/archive#201212">December, 2012</a></li>
                <li><a href="/archive#201211">November, 2012</a></li>
                <li><a href="/archive#201210">October, 2012</a></li>
                <li><a href="/archive#20129">September, 2012</a></li>
                <li><a href="/archive#20124">April, 2012</a></li>
                <li><a href="/archive#20123">March, 2012</a></li>
                <li><a href="/archive#20122">February, 2012</a></li>
                <li><a href="/archive#20121">January, 2012</a></li>
                <li><a href="/archive#201112">December, 2011</a></li>
                <li><a href="/archive#201111">November, 2011</a></li>
                <li><a href="/archive#201110">October, 2011</a></li>
        </ul>
    </aside>
</div>
<!-- #secondary .widget-area -->


</div>
<!-- #main -->

<footer id="colophon" class="site-footer" role="contentinfo">
    <div class="site-info">
        Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a>.	
    </div>
    <!-- .site-info -->
</footer>
<!-- #colophon .site-footer -->
</div>
<!-- #page .hfeed .site -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src='/javascripts/prettify.js' type='text/javascript'></script>

<script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-37975068-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>

<script type='text/javascript'>
  $(function () {
    $("pre code").parent().each(function () {
      if (!$(this).hasClass("prettyprint")) {
        $(this).addClass("prettyprint");
        a = true
    }
});

    prettyPrint();
});


  $(function(){
    $.ajax({
        url: "http://dynamic.xkcd.com/api-0/jsonp/comic?callback=?",
        dataType: "json",
        jsonpCallback: "xkcddata",
        success: function(data) {
            $("#xkcdcontent").append(
                $("<h1/>").text(data.title),
                $("<img/>").attr({
                    src: data.img,
                    title: data.alt,
                    alt: data.title
                })
                );
        }
    });
});
</script>
</body>
</html>
